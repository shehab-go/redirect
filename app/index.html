<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="ØªÙˆØ¬ÙŠÙ‡ Ø±ÙˆØ§Ø¨Ø· ØªØ·Ø¨ÙŠÙ‚Ø§Øª Android Ø¥Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ Droidify">
    <meta name="robots" content="noindex, nofollow">
    <title>ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ | Droidify Redirector</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #333;
        }

        /* Container */
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Logo/Icon */
        .icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
        }

        /* Title */
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #2d3748;
            font-weight: 600;
        }

        h1.en {
            font-size: 20px;
            margin-top: 15px;
            font-weight: 500;
            color: #718096;
        }

        /* Message */
        .message {
            font-size: 16px;
            color: #4a5568;
            margin: 20px 0;
            line-height: 1.6;
        }

        .message.en {
            font-size: 14px;
            color: #718096;
            margin-top: 10px;
        }

        /* Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message */
        .error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }

        .error.en {
            margin-top: 10px;
            font-size: 13px;
        }

        /* Button */
        .button {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .button:active {
            transform: translateY(0);
        }

        /* Hidden class */
        .hidden {
            display: none;
        }

        /* LTR Support */
        [dir="ltr"] {
            direction: ltr;
            text-align: left;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
            }

            h1 {
                font-size: 20px;
            }

            .icon {
                width: 60px;
                height: 60px;
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">ðŸ“±</div>
        <div id="loading">
            <h1>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...</h1>
            <h1 class="en">Redirecting...</h1>
            <div class="spinner"></div>
            <p class="message">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</p>
            <p class="message en">Please wait, opening the app</p>
        </div>

        <div id="error" class="hidden">
            <h1 style="color: #c53030;">Ø®Ø·Ø£</h1>
            <h1 class="en" style="color: #c53030;">Error</h1>
            <div class="error">
                <p id="errorMessage">Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­</p>
                <p id="errorMessageEn" class="en">Invalid link</p>
            </div>
        </div>

        <div id="fallback" class="hidden">
            <h1>Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØ§Ø­</h1>
            <h1 class="en">App Not Available</h1>
            <p class="message">Ù„Ù… ÙŠØªÙ… ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
            <p class="message en">The app did not open automatically</p>
            <a id="playStoreLink" href="#" class="button" target="_blank">
                ÙØªØ­ ÙÙŠ Google Play
            </a>
        </div>
    </div>

    <script>
        (function() {
            'use strict';

            // Ø§Ù„Ø¹Ù†Ø§ØµØ± DOM
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const fallbackDiv = document.getElementById('fallback');
            const errorMessage = document.getElementById('errorMessage');
            const errorMessageEn = document.getElementById('errorMessageEn');
            const playStoreLink = document.getElementById('playStoreLink');

            /**
             * ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù„Ù…Ù†Ø¹ XSS
             */
            function sanitizeInput(input) {
                if (!input) return '';
                return input.replace(/[<>\"']/g, '');
            }

            /**
             * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© package name
             */
            function isValidPackageName(packageId) {
                if (!packageId) return false;
                // Package name ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ dots Ùˆ Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
                return /^[a-z][a-z0-9_]*(\.[a-z][a-z0-9_]*)+$/.test(packageId);
            }

            /**
             * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© URL
             */
            function isValidUrl(url) {
                try {
                    new URL(url);
                    return true;
                } catch {
                    return false;
                }
            }

            /**
             * Validate SHA-256 fingerprint format
             */
            function isValidFingerprint(fingerprint) {
                if (!fingerprint) return false;
                const normalized = fingerprint.trim().toUpperCase();
                const colonPattern = /^([0-9A-F]{2}(:[0-9A-F]{2}){31})$/;
                const compactPattern = /^[0-9A-F]{64}$/;
                return colonPattern.test(normalized) || compactPattern.test(normalized);
            }

            function hideAll() {
                loadingDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');
                fallbackDiv.classList.add('hidden');
            }

            /**
             * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
             */
            function showError(message, messageEn) {
                hideAll();
                errorMessage.textContent = message;
                errorMessageEn.textContent = messageEn;
                errorDiv.classList.remove('hidden');
            }

            /**
             * Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Google Play Store
             */
            function showPlayStoreFallback(packageId, repoAddress) {
                hideAll();
                let fallbackUrl = 'https://play.google.com/store/apps/details?id=' + encodeURIComponent(packageId);
                let fallbackLabel = '??? ?? Google Play<br><span style="font-size: 12px; opacity: 0.8;">Open in Google Play</span>';

                if (repoAddress) {
                    fallbackUrl = repoAddress;
                    fallbackLabel = '??? ?????? ????????<br><span style="font-size: 12px; opacity: 0.8;">Open repository source</span>';
                }

                playStoreLink.href = fallbackUrl;
                playStoreLink.innerHTML = fallbackLabel;
                fallbackDiv.classList.remove('hidden');
            }

            /**
             * Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
             */
            function redirect() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const packageId = urlParams.get('id');
                    const repoAddress = urlParams.get('repo_address');
                    const repoFingerprint = urlParams.get('repo_fingerprint');

                    if (!packageId) {
                        showError(
                            'OrO?O?: O?OO"O? O?USO? O?O-USO-. USO?O" O?O-O_USO_ package name.',
                            'Error: Invalid link. Package name must be specified.'
                        );
                        return;
                    }

                    const cleanPackageId = sanitizeInput(packageId);
                    const cleanRepoAddress = repoAddress ? sanitizeInput(repoAddress) : null;
                    const cleanRepoFingerprint = repoFingerprint ? sanitizeInput(repoFingerprint) : null;

                    if (!isValidPackageName(cleanPackageId)) {
                        showError(
                            'OrO?O?: package name O?USO? O?O-USO-.',
                            'Error: Invalid package name format.'
                        );
                        return;
                    }

                    if (cleanRepoAddress && !isValidUrl(cleanRepoAddress)) {
                        showError(
                            'OrO?O?: O1U+U^OU+ OU,U.O3O?U^O_O1 O?USO? O?O-USO-.',
                            'Error: Invalid repository address.'
                        );
                        return;
                    }

                    if (cleanRepoFingerprint && !isValidFingerprint(cleanRepoFingerprint)) {
                        showError(
                            'Error: Invalid repository fingerprint.',
                            'Error: Invalid repository fingerprint format.'
                        );
                        return;
                    }

                    let deepLink = 'fdroid.app://' + cleanPackageId;
                    const deepLinkParams = [];
                    if (cleanRepoAddress) {
                        deepLinkParams.push('repo_address=' + encodeURIComponent(cleanRepoAddress));
                    }
                    if (cleanRepoFingerprint) {
                        deepLinkParams.push('repo_fingerprint=' + encodeURIComponent(cleanRepoFingerprint));
                    }
                    if (deepLinkParams.length > 0) {
                        deepLink += '?' + deepLinkParams.join('&');
                    }

                    console.log('Deep Link:', deepLink);
                    console.log('Package ID:', cleanPackageId);
                    if (cleanRepoAddress) {
                        console.log('Repo Address:', cleanRepoAddress);
                    }
                    if (cleanRepoFingerprint) {
                        console.log('Repo Fingerprint:', cleanRepoFingerprint);
                    }

                    window.location.href = deepLink;

                    let hasNavigated = false;

                    window.addEventListener('blur', function() {
                        hasNavigated = true;
                    });

                    setTimeout(function() {
                        if (!hasNavigated) {
                            showPlayStoreFallback(cleanPackageId, cleanRepoAddress);
                        }
                    }, 2000);

                }
            } catch (error) {
                    console.error('Error during redirect:', error);
                    showError(
                        'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
                        'An unexpected error occurred. Please try again.'
                    );
                }
            }

            // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            window.addEventListener('DOMContentLoaded', redirect);

            // Ø¯Ø¹Ù… LTR Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… RTL Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯
            if (navigator.language && !navigator.language.startsWith('ar')) {
                document.documentElement.setAttribute('dir', 'ltr');
                document.documentElement.setAttribute('lang', 'en');
            }

        })();
    </script>
</body>
</html>
